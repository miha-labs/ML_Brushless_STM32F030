/* -----------------------------------------------------------------------------
	include
----------------------------------------------------------------------------- */
#include	"ML_TIM.h"

#include	"Common/Control.h"


/* -----------------------------------------------------------------------------
	Local Macro
----------------------------------------------------------------------------- */



/* -----------------------------------------------------------------------------
	Local Variable
----------------------------------------------------------------------------- */



/* -----------------------------------------------------------------------------
	local Structure
----------------------------------------------------------------------------- */
extern TIM_HandleTypeDef htim3;
extern TIM_HandleTypeDef htim6;


/* -----------------------------------------------------------------------------
	local function
----------------------------------------------------------------------------- */



/* -----------------------------------------------------------------------------
	private function
----------------------------------------------------------------------------- */



/* -----------------------------------------------------------------------------
	public function
----------------------------------------------------------------------------- */
void TIM_Startup(void)
{
	/* TIM3 */
	HAL_TIMEx_HallSensor_Start_IT(&htim3);			// �z�[���Z���T���荞��
	__HAL_TIM_ENABLE_IT(&htim3, TIM_IT_UPDATE);		// TIM3�I�[�o�[�t���[(�z�[���Z���T���荞�݂�500msec�������Ȃ�)���荞��
	
	/* TIM6 */
	HAL_TIM_Base_Start_IT(&htim6);
}


void HAL_TIM_IC_CaptureCallback(TIM_HandleTypeDef *htim)
{
	/* �z�[���Z���T�؂�ւ�芄�荞�� */
	uint32_t cnt_hall = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_1);
	
	Ctr_HallSensorDetection(cnt_hall);			// PWM�o�͐؂�ւ�/���x���Z
	
	__HAL_TIM_CLEAR_IT(htim, TIM_IT_UPDATE);	// �z�[���Z���T�̊��荞�݂��������ꍇ�̓I�[�o�[�t���[���荞�݃X�L�b�v
}


void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
	/* ��莞�ԃz�[���Z���T���荞�ݖ��� */
	if(htim->Instance==TIM3)
	{
		Ctr_HallSensorTimeout();
	}
	
	/* 10msec��������荞�� */
	if(htim->Instance==TIM6)
	{
		Ctr_ControlMotor();	// ���[�^�[����
		Ctr_LogWrite();		// ���x/�d�����O
	}
}